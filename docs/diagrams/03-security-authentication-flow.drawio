<?xml version="1.0" encoding="UTF-8"?>
<mxfile host="app.diagrams.net" modified="2024-12-19T18:00:00.000Z" agent="5.0" etag="example" version="24.0.0">
  <diagram name="Security Authentication Flow" id="security-auth-flow">
    <mxGraphModel dx="1422" dy="800" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="1400" pageHeight="900" math="0" shadow="0">
      <root>
        <mxCell id="0" />
        <mxCell id="1" parent="0" />
        
        <!-- Background -->
        <mxCell id="background" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#1B3B4D;strokeColor=none;" vertex="1" parent="1">
          <mxGeometry x="0" y="0" width="1400" height="900" as="geometry" />
        </mxCell>
        
        <!-- Title -->
        <mxCell id="title" value="Azure Communication Services Email MCP Tool - Security &amp; Authentication Flow" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontStyle=1;fontSize=18;fontColor=#FFFFFF;" vertex="1" parent="1">
          <mxGeometry x="350" y="20" width="700" height="30" as="geometry" />
        </mxCell>
        
        <!-- Client Authentication Section -->
        <mxCell id="client-section" value="Client Authentication Flow (APIM Scenario)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#2D4A5A;strokeColor=#8B5FBF;strokeWidth=2;fontStyle=1;fontSize=14;fontColor=#8B5FBF;verticalAlign=top;" vertex="1" parent="1">
          <mxGeometry x="50" y="80" width="1300" height="200" as="geometry" />
        </mxCell>
        
        <!-- VS Code Client -->
        <mxCell id="client" value="" style="image;aspect=fixed;perimeter=ellipsePerimeter;html=1;align=center;shadow=0;dashed=0;spacingTop=3;image=img/lib/azure2/other/Visual_Studio_Code.svg;fontSize=12;" vertex="1" parent="1">
          <mxGeometry x="80" y="120" width="50" height="50" as="geometry" />
        </mxCell>
        
        <mxCell id="client-label" value="VS Code&#xa;MCP Client" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=10;fontColor=#FFFFFF;" vertex="1" parent="1">
          <mxGeometry x="65" y="175" width="80" height="30" as="geometry" />
        </mxCell>
        
        <!-- API Management -->
        <mxCell id="apim" value="" style="image;aspect=fixed;perimeter=ellipsePerimeter;html=1;align=center;shadow=0;dashed=0;spacingTop=3;image=img/lib/azure2/app_services/API_Management_Services.svg;fontSize=12;" vertex="1" parent="1">
          <mxGeometry x="280" y="115" width="68" height="62" as="geometry" />
        </mxCell>
        
        <mxCell id="apim-label" value="API Management&#xa;OAuth2 Gateway" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=10;fontColor=#FFFFFF;" vertex="1" parent="1">
          <mxGeometry x="260" y="180" width="108" height="30" as="geometry" />
        </mxCell>
        
        <!-- Entra ID -->
        <mxCell id="entra-id" value="" style="image;aspect=fixed;perimeter=ellipsePerimeter;html=1;align=center;shadow=0;dashed=0;spacingTop=3;image=img/lib/azure2/identity/Azure_Active_Directory.svg;fontSize=12;" vertex="1" parent="1">
          <mxGeometry x="480" y="115" width="68" height="62" as="geometry" />
        </mxCell>
        
        <mxCell id="entra-label" value="Microsoft Entra ID&#xa;Identity Provider" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=10;fontColor=#FFFFFF;" vertex="1" parent="1">
          <mxGeometry x="460" y="180" width="108" height="30" as="geometry" />
        </mxCell>
        
        <!-- User Browser -->
        <mxCell id="browser" value="" style="image;aspect=fixed;perimeter=ellipsePerimeter;html=1;align=center;shadow=0;dashed=0;spacingTop=3;image=img/lib/azure2/other/Browser.svg;fontSize=12;" vertex="1" parent="1">
          <mxGeometry x="680" y="115" width="68" height="62" as="geometry" />
        </mxCell>
        
        <mxCell id="browser-label" value="User Browser&#xa;(OAuth2 Flow)" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=10;fontColor=#FFFFFF;" vertex="1" parent="1">
          <mxGeometry x="660" y="180" width="108" height="30" as="geometry" />
        </mxCell>
        
        <!-- Function App -->
        <mxCell id="function-app" value="" style="image;aspect=fixed;perimeter=ellipsePerimeter;html=1;align=center;shadow=0;dashed=0;spacingTop=3;image=img/lib/azure2/compute/Function_Apps.svg;fontSize=12;" vertex="1" parent="1">
          <mxGeometry x="880" y="115" width="68" height="60" as="geometry" />
        </mxCell>
        
        <mxCell id="function-label" value="Azure Functions&#xa;MCP Server" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=10;fontColor=#FFFFFF;" vertex="1" parent="1">
          <mxGeometry x="860" y="180" width="108" height="30" as="geometry" />
        </mxCell>
        
        <!-- Protected Resource Metadata -->
        <mxCell id="prm" value="" style="image;aspect=fixed;perimeter=ellipsePerimeter;html=1;align=center;shadow=0;dashed=0;spacingTop=3;image=img/lib/azure2/security/Azure_Information_Protection.svg;fontSize=12;" vertex="1" parent="1">
          <mxGeometry x="1080" y="115" width="68" height="62" as="geometry" />
        </mxCell>
        
        <mxCell id="prm-label" value="Protected Resource&#xa;Metadata (PRM)" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=10;fontColor=#FFFFFF;" vertex="1" parent="1">
          <mxGeometry x="1060" y="180" width="108" height="30" as="geometry" />
        </mxCell>
        
        <!-- OAuth2 Flow Arrows -->
        <mxCell id="flow1" value="1. MCP Request" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeColor=#8B5FBF;strokeWidth=2;fontSize=9;fontColor=#8B5FBF;" edge="1" parent="1" source="client" target="apim">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        
        <mxCell id="flow2" value="2. 404 + PRM Header" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeColor=#FF9800;strokeWidth=2;fontSize=9;fontColor=#FF9800;startArrow=classic;startFill=1;" edge="1" parent="1" source="apim" target="client">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        
        <mxCell id="flow3" value="3. PRM Request" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeColor=#40E0D0;strokeWidth=2;fontSize=9;fontColor=#40E0D0;" edge="1" parent="1" source="client" target="prm">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="105" y="210" />
              <mxPoint x="1114" y="210" />
            </Array>
          </mxGeometry>
        </mxCell>
        
        <mxCell id="flow4" value="4. OAuth2 Config" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeColor=#40E0D0;strokeWidth=2;fontSize=9;fontColor=#40E0D0;startArrow=classic;startFill=1;" edge="1" parent="1" source="prm" target="client">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="1114" y="220" />
              <mxPoint x="105" y="220" />
            </Array>
          </mxGeometry>
        </mxCell>
        
        <mxCell id="flow5" value="5. Auth Redirect" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeColor=#9C4F96;strokeWidth=2;fontSize=9;fontColor=#9C4F96;" edge="1" parent="1" source="client" target="browser">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="105" y="100" />
              <mxPoint x="714" y="100" />
            </Array>
          </mxGeometry>
        </mxCell>
        
        <mxCell id="flow6" value="6. Login Flow" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeColor=#9C4F96;strokeWidth=2;fontSize=9;fontColor=#9C4F96;startArrow=classic;startFill=1;" edge="1" parent="1" source="entra-id" target="browser">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        
        <mxCell id="flow7" value="7. Auth Token" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeColor=#32CD32;strokeWidth=2;fontSize=9;fontColor=#32CD32;" edge="1" parent="1" source="browser" target="client">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="714" y="250" />
              <mxPoint x="105" y="250" />
            </Array>
          </mxGeometry>
        </mxCell>
        
        <mxCell id="flow8" value="8. Authenticated Request" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeColor=#32CD32;strokeWidth=3;fontSize=9;fontColor=#32CD32;" edge="1" parent="1" source="client" target="apim">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="105" y="270" />
              <mxPoint x="314" y="270" />
            </Array>
          </mxGeometry>
        </mxCell>
        
        <mxCell id="flow9" value="9. Forward to Function" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeColor=#32CD32;strokeWidth=3;fontSize=9;fontColor=#32CD32;" edge="1" parent="1" source="apim" target="function-app">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        
        <!-- Service-to-Service Section -->
        <mxCell id="service-section" value="Service-to-Service Authentication (Both Scenarios)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#2D4A5A;strokeColor=#00B7C3;strokeWidth=2;fontStyle=1;fontSize=14;fontColor=#00B7C3;verticalAlign=top;" vertex="1" parent="1">
          <mxGeometry x="50" y="320" width="1300" height="220" as="geometry" />
        </mxCell>
        
        <!-- Function App S2S -->
        <mxCell id="func-s2s" value="" style="image;aspect=fixed;perimeter=ellipsePerimeter;html=1;align=center;shadow=0;dashed=0;spacingTop=3;image=img/lib/azure2/compute/Function_Apps.svg;fontSize=12;" vertex="1" parent="1">
          <mxGeometry x="150" y="360" width="68" height="60" as="geometry" />
        </mxCell>
        
        <mxCell id="func-s2s-label" value="Azure Functions&#xa;MCP Server" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=10;fontColor=#FFFFFF;" vertex="1" parent="1">
          <mxGeometry x="130" y="425" width="108" height="30" as="geometry" />
        </mxCell>
        
        <!-- Managed Identity -->
        <mxCell id="managed-id" value="" style="image;aspect=fixed;perimeter=ellipsePerimeter;html=1;align=center;shadow=0;dashed=0;spacingTop=3;image=img/lib/azure2/identity/Managed_Identities.svg;fontSize=12;" vertex="1" parent="1">
          <mxGeometry x="400" y="360" width="68" height="68" as="geometry" />
        </mxCell>
        
        <mxCell id="managed-id-label" value="System Managed&#xa;Identity" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=10;fontColor=#FFFFFF;" vertex="1" parent="1">
          <mxGeometry x="390" y="435" width="88" height="30" as="geometry" />
        </mxCell>
        
        <!-- ACS -->
        <mxCell id="acs-s2s" value="" style="image;aspect=fixed;perimeter=ellipsePerimeter;html=1;align=center;shadow=0;dashed=0;spacingTop=3;image=img/lib/azure2/communication/Communication_Services.svg;fontSize=12;" vertex="1" parent="1">
          <mxGeometry x="650" y="360" width="68" height="60" as="geometry" />
        </mxCell>
        
        <mxCell id="acs-s2s-label" value="Azure Communication&#xa;Services" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=10;fontColor=#FFFFFF;" vertex="1" parent="1">
          <mxGeometry x="630" y="425" width="108" height="30" as="geometry" />
        </mxCell>
        
        <!-- Email Domain -->
        <mxCell id="email-domain" value="" style="image;aspect=fixed;perimeter=ellipsePerimeter;html=1;align=center;shadow=0;dashed=0;spacingTop=3;image=img/lib/azure2/other/Email_Communication_Services.svg;fontSize=12;" vertex="1" parent="1">
          <mxGeometry x="900" y="360" width="68" height="68" as="geometry" />
        </mxCell>
        
        <mxCell id="email-domain-label" value="Email Domain&#xa;Configuration" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=10;fontColor=#FFFFFF;" vertex="1" parent="1">
          <mxGeometry x="890" y="435" width="88" height="30" as="geometry" />
        </mxCell>
        
        <!-- RBAC -->
        <mxCell id="rbac" value="" style="image;aspect=fixed;perimeter=ellipsePerimeter;html=1;align=center;shadow=0;dashed=0;spacingTop=3;image=img/lib/azure2/security/Azure_Role_Based_Access_Control.svg;fontSize=12;" vertex="1" parent="1">
          <mxGeometry x="1150" y="360" width="68" height="68" as="geometry" />
        </mxCell>
        
        <mxCell id="rbac-label" value="RBAC Permissions&#xa;Communication Contributor" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=10;fontColor=#FFFFFF;" vertex="1" parent="1">
          <mxGeometry x="1130" y="435" width="108" height="30" as="geometry" />
        </mxCell>
        
        <!-- S2S Flow -->
        <mxCell id="s2s-flow1" value="Uses" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeColor=#32CD32;strokeWidth=2;fontSize=9;fontColor=#32CD32;" edge="1" parent="1" source="func-s2s" target="managed-id">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        
        <mxCell id="s2s-flow2" value="Authenticates" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeColor=#32CD32;strokeWidth=2;fontSize=9;fontColor=#32CD32;" edge="1" parent="1" source="managed-id" target="acs-s2s">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        
        <mxCell id="s2s-flow3" value="Email API" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeColor=#40E0D0;strokeWidth=2;fontSize=9;fontColor=#40E0D0;" edge="1" parent="1" source="acs-s2s" target="email-domain">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        
        <mxCell id="s2s-flow4" value="Validates" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeColor=#32CD32;strokeWidth=2;fontSize=9;fontColor=#32CD32;" edge="1" parent="1" source="managed-id" target="rbac">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="434" y="480" />
              <mxPoint x="1184" y="480" />
            </Array>
          </mxGeometry>
        </mxCell>
        
        <!-- Direct Connection Section -->
        <mxCell id="direct-section" value="Direct Connection Alternative (Function Key)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#2D4A5A;strokeColor=#FF9800;strokeWidth=2;fontStyle=1;fontSize=14;fontColor=#FF9800;verticalAlign=top;" vertex="1" parent="1">
          <mxGeometry x="50" y="580" width="1300" height="120" as="geometry" />
        </mxCell>
        
        <mxCell id="direct-note" value="Alternative: Direct Function App connection bypasses APIM and uses Function Key authentication" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=12;fontColor=#FFFFFF;" vertex="1" parent="1">
          <mxGeometry x="70" y="620" width="600" height="20" as="geometry" />
        </mxCell>
        
        <mxCell id="direct-client" value="" style="image;aspect=fixed;perimeter=ellipsePerimeter;html=1;align=center;shadow=0;dashed=0;spacingTop=3;image=img/lib/azure2/other/Visual_Studio_Code.svg;fontSize=12;" vertex="1" parent="1">
          <mxGeometry x="150" y="650" width="40" height="40" as="geometry" />
        </mxCell>
        
        <mxCell id="direct-func" value="" style="image;aspect=fixed;perimeter=ellipsePerimeter;html=1;align=center;shadow=0;dashed=0;spacingTop=3;image=img/lib/azure2/compute/Function_Apps.svg;fontSize=12;" vertex="1" parent="1">
          <mxGeometry x="350" y="645" width="50" height="45" as="geometry" />
        </mxCell>
        
        <mxCell id="direct-flow" value="HTTPS + Function Key" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeColor=#FF9800;strokeWidth=3;fontSize=10;fontColor=#FF9800;" edge="1" parent="1" source="direct-client" target="direct-func">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        
        <mxCell id="security-note" value="Security Notes:&#xa;• APIM scenario provides OAuth2/PKCE authentication with Entra ID&#xa;• Direct scenario uses simpler function key authentication&#xa;• Both scenarios use Managed Identity for service-to-service calls&#xa;• RBAC controls access to Azure Communication Services" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#3A5F73;strokeColor=#40E0D0;strokeWidth=1;fontSize=10;fontColor=#FFFFFF;" vertex="1" parent="1">
          <mxGeometry x="500" y="610" width="300" height="80" as="geometry" />
        </mxCell>
        
        <!-- Legend -->
        <mxCell id="legend-bg" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#2D4A5A;strokeColor=#FFFFFF;strokeWidth=1;" vertex="1" parent="1">
          <mxGeometry x="900" y="610" width="200" height="80" as="geometry" />
        </mxCell>
        
        <mxCell id="legend-title" value="Authentication Types" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontStyle=1;fontSize=11;fontColor=#FFFFFF;" vertex="1" parent="1">
          <mxGeometry x="920" y="620" width="160" height="15" as="geometry" />
        </mxCell>
        
        <mxCell id="legend-oauth" value="OAuth2/PKCE Flow" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=9;fontColor=#8B5FBF;" vertex="1" parent="1">
          <mxGeometry x="920" y="640" width="120" height="12" as="geometry" />
        </mxCell>
        
        <mxCell id="legend-managed" value="Managed Identity" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=9;fontColor=#32CD32;" vertex="1" parent="1">
          <mxGeometry x="920" y="655" width="120" height="12" as="geometry" />
        </mxCell>
        
        <mxCell id="legend-function" value="Function Key" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=9;fontColor=#FF9800;" vertex="1" parent="1">
          <mxGeometry x="920" y="670" width="120" height="12" as="geometry" />
        </mxCell>
        
      </root>
    </mxGraphModel>
  </diagram>
</mxfile>
